name: GitHub Issue to Jira Sync from Form

on:
  issues:
    types: [opened]

# ğŸ‘‡ ì´ ë¶€ë¶„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!
# ì›Œí¬í”Œë¡œìš°ê°€ ì´ìŠˆì— ëŒ“ê¸€ì„ ì“¸ ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
permissions:
  issues: write

jobs:
  create_jira_issue:
    runs-on: ubuntu-latest
    steps:
      # 1. ì´ìŠˆ ë³¸ë¬¸ì—ì„œ í¼ ì…ë ¥ê°’ ê·¸ëŒ€ë¡œ ì¶”ì¶œ
      - name: Parse Issue Form Body
        id: parse_form
        run: |
          body="${{ github.event.issue.body }}"
          
          # ê° í•­ëª©ì˜ ì‹¤ì œ ì…ë ¥ê°’ì„ ì¶”ì¶œ
          issuetype=$(echo "$body" | grep -A 2 "### âš¡ï¸ ì´ìŠˆ ìœ í˜•" | tail -n 1 | tr -d '\r')
          epic_number=$(echo "$body" | grep -A 2 "### ğŸŸï¸ ìƒìœ„ ì—í”½ Number" | tail -n 1 | tr -d '\r')
          issue_label=$(echo "$body" | grep -A 2 "### ğŸ·ï¸ ë ˆì´ë¸”" | tail -n 1 | tr -d '\r')

          echo "issuetype=$issuetype" >> $GITHUB_OUTPUT
          echo "epic_number=$epic_number" >> $GITHUB_OUTPUT
          echo "issue_label=$issue_label" >> $GITHUB_OUTPUT

      # 2. Jira í•„ë“œ JSONì„ ë™ì ìœ¼ë¡œ ìƒì„±
      - name: Construct Jira Fields
        id: construct_fields
        run: |
          epic_key_raw="${{ steps.parse_form.outputs.epic_number }}"
          labels_raw="${{ steps.parse_form.outputs.issue_label }}"

          json_fields='{}'

          # ì‚¬ìš©ìê°€ ì—í”½ ë²ˆí˜¸ë¥¼ ì…ë ¥í–ˆì„ ë•Œë§Œ parent í•„ë“œë¥¼ JSONì— ì¶”ê°€
          if [[ -n "$epic_key_raw" && "$epic_key_raw" != "_No response_" ]]; then
            json_fields=$(echo "$json_fields" | jq -c --arg key "$epic_key_raw" '.parent = {"key": $key}')
          fi

          # ì‚¬ìš©ìê°€ ë ˆì´ë¸”ì„ ì…ë ¥í–ˆì„ ë•Œë§Œ labels í•„ë“œë¥¼ JSONì— ì¶”ê°€
          if [[ -n "$labels_raw" && "$labels_raw" != "_No response_" ]]; then
            labels_json_array=$(echo "$labels_raw" | jq -R 'split(",") | map(. | ltrim | rtrim) | map(select(length > 0))')
            json_fields=$(echo "$json_fields" | jq -c --argjson labels "$labels_json_array" '.labels = $labels')
          fi

          echo "json=$json_fields" >> $GITHUB_OUTPUT

      # 3. Jira ë¡œê·¸ì¸
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 4. Jira ì´ìŠˆ ìƒì„±
      - name: Create Jira Issue
        id: create_jira
        uses: atlassian/gajira-create@v3
        with:
          project: SCRUM
          issuetype: ${{ steps.parse_form.outputs.issuetype }}
          summary: ${{ github.event.issue.title }}
          description: ${{ github.event.issue.body }}
          fields: ${{ steps.construct_fields.outputs.json }}

      # 5. Jira ì´ìŠˆ ë§í¬ë¥¼ ê¹ƒí—ˆë¸Œ ì´ìŠˆì— ëŒ“ê¸€ë¡œ ì¶”ê°€
      - name: Add Jira link to GitHub issue
        uses: actions/github-script@v6
        with:
          script: |
            const jiraIssueKey = "${{ steps.create_jira.outputs.issue }}";
            const jiraBaseUrl = "${{ secrets.JIRA_BASE_URL }}";
            const commentBody = `âœ… **Jira Issue Created:** [${jiraIssueKey}](${jiraBaseUrl}/browse/${jiraIssueKey})`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
